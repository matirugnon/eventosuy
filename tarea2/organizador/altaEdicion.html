<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alta de edición · eventos.uy</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
  <style>
    /* Pequeños ajustes específicos para esta vista */
    .note { color:#555; font-size: .9rem; }
  </style>
  </head>
<body>
  <div>
    <header class="header">
      <h1><a href="principalOrganizador.html" style="color: inherit; text-decoration: none;">eventos.uy</a></h1>
      <div class="header-right">
        <div class="user-badge">
          <img class="avatar" src="../img/IMG-US04.jpeg" alt="Avatar organizador" />
          <span class="nickname" id="nick">MisEventos</span>
        </div>
        <a href="../index.html" class="btn-primary">Cerrar sesión</a>
        
      </div>
    </header>

    <div class="content">
      <aside class="sidebar">
        <div class="panel sidebar">
          <div class="panel-header">Mi perfil</div>
          <ul class="menu-list" style="margin-bottom: 3rem;">
            <li><a href="altaEvento.html">Alta Evento</a></li>
            <li><a href="altaEdicion.html">Alta Edición</a></li>
            <li><a href="altaInstitucion.html">Alta Institución</a></li>
            <li><a href="altadeTipodeRegistro.html">Alta Tipo de Registro</a></li>
            <li><a href="consultaRegistro.html">Consulta Registro</a></li>
          </ul>
          <div class="panel-header">Categorías</div>
          <ul class="menu-list">
            <li><a href="tecnologiaOrganizador.html">Tecnología</a></li>
            <li><a href="innovacionOrganizador.html">Innovación</a></li>
            <li><a href="saludOrganizador.html">Salud</a></li>
            <li><a href="deporteOrganizador.html">Deporte</a></li>
          </ul>
        </div>
        <div style="margin-top: 2rem; border-top: 1px solid #e0e0e0; padding-top: 1rem;">
          <a href="../listarUsuariosOrganizador.html" style="
              display: flex;
              align-items: center;
              gap: 0.5rem;
              color: #182080;
              font-weight: 600;
              text-decoration: none;
              padding: 0.75rem;
              border-radius: 6px;
              transition: background-color 0.2s;
              background-color: rgba(24, 32, 128, 0.05);
          ">
            Ver listado de usuarios
          </a>
        </div>
      </aside>

      <main>
        <section class="panel">
          <div class="panel-header">Alta de Edición de Evento</div>
          <div class="panel-body">
            <form id="formEdicion" class="auth-form" novalidate>
              <div class="grid-2">
                <label class="form-group">
                  <span class="label-text">Evento</span>
                  <input name="eventoTitulo" readonly />
                  <input type="hidden" name="eventoSlug" />
                </label>

                <label class="form-group">
                  <span class="label-text">Nombre de la edición (único) *</span>
                  <input name="nombre" required maxlength="140"  />
                </label>
              </div>

              <div class="grid-2">
                <label class="form-group">
                  <span class="label-text">Sigla *</span>
                  <input name="sigla" required maxlength="20"  />
                </label>
                <label class="form-group">
                  <span class="label-text">Ciudad *</span>
                  <input name="ciudad" required maxlength="60" />
                </label>
              </div>

              <div class="grid-2">
                <label class="form-group">
                  <span class="label-text">País *</span>
                  <input name="pais" required maxlength="60"  />
                </label>
                <div></div>
              </div>

              <div class="grid-2">
                <label class="form-group">
                  <span class="label-text">Fecha de inicio *</span>
                  <input type="date" name="fechaInicio" required />
                </label>
                <label class="form-group">
                  <span class="label-text">Fecha de fin *</span>
                  <input type="date" name="fechaFin" required />
                </label>
              </div>

              <label class="form-group">
                <span class="label-text">Imagen (opcional)</span>
                <input type="file" name="imagen" accept="image/*" />
              </label>
              <div id="preview" style="display:none; margin:.5rem 0;">
                <img id="previewImg" alt="Previsualización" style="max-width:220px;border:1px solid #ddd;border-radius:8px;" />
              </div>

              <div id="msg" style="color:#c00; margin-top:.5rem; min-height:1.25rem;"></div>

              <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                <button type="submit" class="btn-primary">Crear edición</button>
                <a class="btn-outline" href="consultaeventoorganizador.html">Cancelar</a>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>
  </div>

  <style>
    .auth-form {
      max-width: 600px;
      margin: 0 auto;
    }
    .auth-form .form-group {
      margin-bottom: 1rem;
    }
    .auth-form .form-group .label-text {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .auth-form input[type="text"],
    .auth-form input[type="file"],
    .auth-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }
    .auth-form input[type="text"]:focus,
    .auth-form input[type="file"]:focus,
    .auth-form textarea:focus {
      border-color: #182080;
      outline: none;
      box-shadow: 0 0 3px rgba(24, 32, 128, 0.5);
    }
    .auth-form textarea {
      resize: vertical;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
  </style>


  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => document.querySelectorAll(s);

      // Usuario actual (mock)
      const CURRENT_USER = (localStorage.getItem('CURRENT_USER') || 'luissuarez9');
      const nickEl = document.getElementById('nick');
      if (nickEl) nickEl.textContent = CURRENT_USER;

      // Keys LS
      const LS_EVENTS = 'EVENTS_MOCK';
      const LS_EDITIONS = 'EDITIONS_MOCK';

      const form = $('#formEdicion');
      const msg = $('#msg');
      const inputImg = form.elements['imagen'];
      const preview = $('#preview');
      const previewImg = $('#previewImg');
      const inputEventoTitulo = form.elements['eventoTitulo'];
      const inputEventoSlug = form.elements['eventoSlug'];

      const slugify = (s) => s
         .toLowerCase()
         .normalize('NFD').replace(/\p{Diacritic}+/gu, '')
         .replace(/[^a-z0-9]+/g,'-')
         .replace(/^-+|-+$/g,'');

      function toDDMMYYYY(date){
        const d = new Date(date);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function todayDDMMYYYY(){
        return toDDMMYYYY(new Date());
      }

      function showPreview(file){
        if(!file){ preview.style.display='none'; previewImg.src=''; return; }
        const reader = new FileReader();
        reader.onload = () => { previewImg.src = reader.result; preview.style.display = ''; };
        reader.readAsDataURL(file);
      }

      // Resolver evento desde parámetros
      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      async function inicializarEventoDesdeURL(){
        const slugURL = getParam('evento');
        const tituloURL = getParam('titulo');
        if(!slugURL && !tituloURL){
          msg.textContent = 'No se especificó el evento. Vuelve al detalle del evento para crear la edición.';
          return false;
        }
        // Intentar resolver título si no vino
        let titulo = tituloURL || '';
        if(!titulo){
          // Buscar en eventos.json y EVENTS_MOCK por coincidencia de slug
          const locales = JSON.parse(localStorage.getItem(LS_EVENTS) || '[]').map(e=>e.nombre);
          let externos = [];
          try {
            const r = await fetch('eventos.json');
            externos = (await r.json()).map(e=>e.titulo);
          } catch {}
          const candidatos = [...externos, ...locales];
          const hit = candidatos.find(t => slugify(t) === slugURL);
          if(hit) titulo = hit;
        }
        inputEventoSlug.value = slugURL || slugify(titulo);
        inputEventoTitulo.value = titulo || '(evento sin título)';
        return !!inputEventoSlug.value;
      }

      // Cargar ediciones existentes para validar unicidad por nombre
      async function cargarEdicionesExistentes(){
        let json = [];
        try {
          const r = await fetch('ediciones.json');
          const data = await r.json();
          json = Array.isArray(data.ediciones) ? data.ediciones : [];
        } catch {}
        const locales = JSON.parse(localStorage.getItem(LS_EDITIONS) || '[]');
        return [...json, ...locales];
      }

      function validarRangoFechas(fi, ff){
        const a = new Date(fi), b = new Date(ff);
        return a.getTime() <= b.getTime();
      }

      function validarCampos(){
        msg.style.color = '#c00';
        msg.textContent = '';
        return form.reportValidity();
      }

      inputImg && inputImg.addEventListener('change', e => showPreview(e.target.files?.[0]));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(!validarCampos()) return;

        const tituloEvento = inputEventoTitulo.value;
        const slugEvento = inputEventoSlug.value;
        const nombre = form.elements['nombre'].value.trim();
        const sigla = form.elements['sigla'].value.trim();
        const ciudad = form.elements['ciudad'].value.trim();
        const pais = form.elements['pais'].value.trim();
        const fi = form.elements['fechaInicio'].value;
        const ff = form.elements['fechaFin'].value;

        if(!validarRangoFechas(fi, ff)){
          msg.textContent = 'La fecha de inicio no puede ser posterior a la de fin.';
          return;
        }

        // Unicidad de nombre de edición
        const existentes = await cargarEdicionesExistentes();
        const dup = existentes.some(e => (e.nombre || '').trim().toLowerCase() === nombre.toLowerCase());
        if(dup){
          msg.textContent = 'El nombre de la edición ya está en uso. Modifícalo o cancela.';
          return;
        }

        const anio = new Date(fi).getFullYear();
        const id = `${slugEvento}-${anio}`;

        // Imagen: tomar base64 si hay
        const imgSrc = previewImg && previewImg.src ? previewImg.src : '';

        const nueva = {
          id,
          evento: tituloEvento,
          nombre,
          ciudad,
          pais,
          sigla,
          fechaInicio: toDDMMYYYY(fi),
          fechaFin: toDDMMYYYY(ff),
          fechaAlta: todayDDMMYYYY(), // fecha actual
          img: imgSrc,
          estado: 'Ingresada',
          organizador: CURRENT_USER
        };

        const arr = JSON.parse(localStorage.getItem(LS_EDITIONS) || '[]');
        arr.push(nueva);
        localStorage.setItem(LS_EDITIONS, JSON.stringify(arr));

        msg.style.color = '#2a7f2e';
        msg.textContent = '✅ Edición dada de alta en estado “Ingresada”.';
        setTimeout(()=>{ window.location.href = 'consultaeventoorganizador.html'; }, 1200);
      });

      // Inicializar
      inicializarEventoDesdeURL();
    })();
  </script>
</body>
</html>
