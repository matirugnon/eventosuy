<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro a Edición · eventos.uy</title>  <link rel="icon" type="image/png" href="../img/favicon.png">
  <link rel="stylesheet" href="../styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div>
    <header class="header">
      <a href="principalAsistente.html"><h1>eventos.uy</h1></a>
      <div class="header-right">
        <div class="user-badge">
          <a href="consultaPerfil.html" style="display:flex;align-items:center;gap:.5rem;text-decoration:none;color:inherit;">
            <img class="avatar" src="../img/IMG-US01.jpg" alt="atorres" />
            <span class="nickname">atorres</span>
          </a>
        </div>
        <a href="../index.html" class="btn-primary">Cerrar sesión</a>
      </div>
    </header>
    <div class="content">
      <aside class="sidebar">
        <div class="panel sidebar">
          <div class="panel-header">Mi perfil</div>
          <ul class="menu-list">
            <li><a href="registroAedicion.html">Registro a Edición</a></li>
          </ul>
        </div>
        <div class="panel sidebar" style="margin-top:1rem;">
          <div class="panel-header">Categorías</div>
          <ul class="menu-list">
            <li><a href="tecnologiaAsistente.html">Tecnología</a></li>
            <li><a href="innovacionAsistente.html">Innovación</a></li>
            <li><a href="saludAsistente.html">Salud</a></li>
            <li><a href="deporteAsistente.html">Deporte</a></li>
          </ul>
        </div>
        <div style="margin-top: 2rem; border-top: 1px solid #e0e0e0; padding-top: 1rem;">
          <a href="listarUsuariosAsistente.html" style="display:flex;align-items:center;gap:.5rem;color:#182080;font-weight:600;text-decoration:none;padding:.75rem;border-radius:6px;transition:background-color .2s;background-color:rgba(24,32,128,.05);">Ver listado de usuarios</a>
        </div>
      </aside>
      <main>
        <section class="panel" style="max-width:700px;margin:0 auto;">
          <div class="panel-header">Registro a Edición de Evento</div>
          <div class="panel-body">
            <!-- Paso 1: Selección de evento -->
            <div class="consulta-registro-form-row">
              <label class="form-group" style="margin-bottom:0;">
                <span class="label-text">Seleccioná un evento</span>
              </label>
              <select id="eventoSelect" required>
                <option value="">Seleccionar…</option>
                <option value="maraton">Maratón de Montevideo</option>
                <option value="tecnologia">Tecnología Punta del Este</option>
                <option value="websummit">Web Summit</option>
              </select>
            </div>
            <!-- Paso 2: Selección de edición -->
            <div class="consulta-registro-form-row" id="step-edicion" style="display:none;">
              <label class="form-group" style="margin-bottom:0;">
                <span class="label-text">Seleccioná una edición</span>
              </label>
              <select id="edicionSelect" required>
                <option value="">Seleccionar…</option>
              </select>
            </div>
            <!-- Paso 3: Detalle de edición y tipos de registro -->
            <div id="step-detalle" style="display:none;">
              <div class="panel" style="background:#f8f9ff;">
                <div class="panel-header" style="color:#182080;">Detalle de la edición</div>
                <div class="panel-body">
                  <p><strong>Nombre:</strong> <span id="edicionNombre"></span></p>
                  <p><strong>Fechas:</strong> <span id="edicionFechas"></span></p>
                  <p><strong>Ciudad:</strong> <span id="edicionCiudad"></span></p>
                  <p><strong>País:</strong> <span id="edicionPais"></span></p>
                  <p><strong>Tipos de registro:</strong></p>
                  <div id="tiposRegistro"></div>
                </div>
              </div>
            </div>
            <!-- Paso 4: Registro -->
            <form id="formRegistro" style="display:none; margin-top:1.5rem;">
              <div class="consulta-registro-form-row">
                <label class="form-group" style="margin-bottom:0;">
                  <span class="label-text">Tipo de registro</span>
                </label>
                <select id="tipoRegistroSelect" required></select>
              </div>
              <div class="consulta-registro-form-row">
                <label class="form-group" style="margin-bottom:0;">
                  <span class="label-text">¿Usar código de patrocinio?</span>
                </label>
                <input type="text" id="codigoPatrocinio" placeholder="Ingresá el código (opcional)" style="min-width:220px;max-width:340px;width:100%;" />
              </div>
              <div id="msg" style="color:#c00; margin-top:.5rem; min-height:1.25rem;"></div>
              <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                <button type="submit" class="btn-primary">Registrarme</button>
                <a class="btn-outline" href="principalAsistente.html">Cancelar</a>
              </div>
            </form>
            <div id="msgFinal" style="margin-top:1.5rem; color:#2a7f2e; font-weight:600;"></div>
          </div>
        </section>
      </main>
    </div>
  </div>
  <script>
    // Mock de datos para la demo
    const eventos = {
      maraton: {
        nombre: 'Maratón de Montevideo',
        ediciones: [
          { id: 'EDEV03', nombre: 'Maratón de Montevideo 2024', fechas: '10/04/2024 - 12/04/2024', ciudad: 'Montevideo', pais: 'Uruguay', tipos: [ { id: 'gen', nombre: 'General', cupo: 100, costo: 1200 }, { id: 'vip', nombre: 'VIP', cupo: 10, costo: 0 } ] },
          { id: 'EDEV04', nombre: 'Maratón de Montevideo 2022', fechas: '10/04/2022 - 12/04/2022', ciudad: 'Montevideo', pais: 'Uruguay', tipos: [ { id: 'gen', nombre: 'General', cupo: 0, costo: 1200 } ] }
        ]
      },
      tecnologia: {
        nombre: 'Tecnología Punta del Este',
        ediciones: [
          { id: 'EDEV08', nombre: 'Tecnología Punta del Este 2026', fechas: '15/09/2026 - 17/09/2026', ciudad: 'Punta del Este', pais: 'Uruguay', tipos: [ { id: 'gen', nombre: 'General', cupo: 50, costo: 800 } ] }
        ]
      },
      websummit: {
        nombre: 'Web Summit',
        ediciones: [
          { id: 'EDEV10', nombre: 'Web Summit 2026', fechas: '01/11/2026 - 03/11/2026', ciudad: 'Montevideo', pais: 'Uruguay', tipos: [ { id: 'gen', nombre: 'General', cupo: 5, costo: 2000 } ] }
        ]
      }
    };
    // Mock de códigos de patrocinio válidos
    const codigosPatrocinio = {
      'PATRO2024': { edicion: 'EDEV03', tipo: 'gen', institucion: 'UDELAR', usos: 2, maxUsos: 2 },
      'VIPTECH': { edicion: 'EDEV08', tipo: 'gen', institucion: 'ORT', usos: 0, maxUsos: 1 }
    };
    // Mock de registros previos
    let registros = [
      { usuario: 'atorres', edicion: 'EDEV03', tipo: 'gen' }
    ];
    const eventoSelect = document.getElementById('eventoSelect');
    const edicionSelect = document.getElementById('edicionSelect');
    const stepEdicion = document.getElementById('step-edicion');
    const stepDetalle = document.getElementById('step-detalle');
    const edicionNombre = document.getElementById('edicionNombre');
    const edicionFechas = document.getElementById('edicionFechas');
    const edicionCiudad = document.getElementById('edicionCiudad');
    const edicionPais = document.getElementById('edicionPais');
    const tiposRegistroDiv = document.getElementById('tiposRegistro');
    const tipoRegistroSelect = document.getElementById('tipoRegistroSelect');
    const formRegistro = document.getElementById('formRegistro');
    const codigoPatrocinio = document.getElementById('codigoPatrocinio');
    const msg = document.getElementById('msg');
    const msgFinal = document.getElementById('msgFinal');
    let edicionActual = null;
    let tiposActuales = [];
    eventoSelect.addEventListener('change', function() {
      edicionSelect.innerHTML = '<option value="">Seleccionar…</option>';
      stepEdicion.style.display = eventoSelect.value ? '' : 'none';
      stepDetalle.style.display = 'none';
      formRegistro.style.display = 'none';
      msgFinal.textContent = '';
      if (!eventoSelect.value) return;
      const eds = eventos[eventoSelect.value].ediciones;
      eds.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = e.nombre;
        edicionSelect.appendChild(opt);
      });
    });
    edicionSelect.addEventListener('change', function() {
      stepDetalle.style.display = 'none';
      formRegistro.style.display = 'none';
      msgFinal.textContent = '';
      if (!edicionSelect.value) return;
      // Buscar datos de la edición
      let found = null;
      Object.values(eventos).forEach(ev => {
        ev.ediciones.forEach(ed => { if (ed.id === edicionSelect.value) found = ed; });
      });
      if (!found) return;
      edicionActual = found;
      edicionNombre.textContent = found.nombre;
      edicionFechas.textContent = found.fechas;
      edicionCiudad.textContent = found.ciudad;
      edicionPais.textContent = found.pais;
      tiposActuales = found.tipos;
      // Mostrar tipos de registro
      tiposRegistroDiv.innerHTML = '';
      tipoRegistroSelect.innerHTML = '';
      found.tipos.forEach(t => {
        const p = document.createElement('p');
        p.textContent = `${t.nombre} (Cupo: ${t.cupo}, Costo: $${t.costo})`;
        tiposRegistroDiv.appendChild(p);
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.nombre;
        tipoRegistroSelect.appendChild(opt);
      });
      stepDetalle.style.display = '';
      formRegistro.style.display = '';
    });
    formRegistro.addEventListener('submit', function(e) {
      e.preventDefault();
      msg.textContent = '';
      msgFinal.textContent = '';
      if (!edicionActual) return;
      const tipoId = tipoRegistroSelect.value;
      const tipo = tiposActuales.find(t => t.id === tipoId);
      if (!tipo) { msg.textContent = 'Seleccioná un tipo de registro.'; return; }
      // Validar cupo
      if (tipo.cupo <= 0) {
        msg.textContent = 'Ya se alcanzó el cupo para este tipo de registro.';
        return;
      }
      // Validar si ya está registrado
      if (registros.some(r => r.usuario === 'atorres' && r.edicion === edicionActual.id)) {
        msg.textContent = 'Ya estás registrado a esta edición.';
        return;
      }
      // Validar código de patrocinio si se ingresó
      let costoFinal = tipo.costo;
      const cod = codigoPatrocinio.value.trim();
      if (cod) {
        const info = codigosPatrocinio[cod];
        if (!info) {
          msg.textContent = 'El código no es válido.';
          return;
        }
        if (info.edicion !== edicionActual.id || info.tipo !== tipoId) {
          msg.textContent = 'El código no es válido para esta edición o tipo de registro.';
          return;
        }
        if (info.usos >= info.maxUsos) {
          msg.textContent = 'Ya se alcanzó la cantidad de usos para este código.';
          return;
        }
        // Simular validación de institución (mock)
        if (info.institucion !== 'UDELAR') {
          msg.textContent = 'El código no es válido para tu institución.';
          return;
        }
        costoFinal = 0;
        info.usos++;
      }
      // Registrar
      registros.push({ usuario: 'atorres', edicion: edicionActual.id, tipo: tipoId });
      msgFinal.textContent = `✅ Registro exitoso. Fecha: ${new Date().toLocaleDateString()} | Costo: $${costoFinal}`;
      formRegistro.style.display = 'none';
    });
  </script>
</body>
</html>
